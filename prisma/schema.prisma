// QAQC SaaS Platform - Prisma Schema
// Updated for Prisma 7 compatibility

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────────────────────────────────────────────
// User & Authentication
// ─────────────────────────────────────────────────────────────────────────────

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // Clerk user ID for authentication
  email     String   @unique
  name      String?
  avatarUrl String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscription Subscription?
  analyses     SavedAnalysis[]
  drafts       AnalysisDraft[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// ─────────────────────────────────────────────────────────────────────────────
// Billing & Subscriptions
// ─────────────────────────────────────────────────────────────────────────────

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe integration
  stripeCustomerId       String?  @unique
  stripeSubscriptionId   String?  @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Plan details
  plan   PlanType           @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

enum PlanType {
  FREE
  PRO_MONTHLY
  PRO_YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

// ─────────────────────────────────────────────────────────────────────────────
// QAQC Analysis Data
// ─────────────────────────────────────────────────────────────────────────────

/// Represents a completed and saved QAQC analysis
model SavedAnalysis {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String // User-defined name for the analysis
  toolType QaqcToolType // Which QAQC tool was used

  // Analysis configuration (JSON)
  config Json

  // Analysis results (JSON)
  results Json

  // Optional hash of uploaded file for caching/deduplication
  fileHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, toolType])
  @@map("saved_analyses")
}

/// Stores in-progress analysis state for draft persistence
model AnalysisDraft {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  toolType QaqcToolType

  // Draft data (JSON)
  data Json

  // Draft configuration (JSON)
  config Json

  // Timestamp of last user interaction
  lastActive DateTime @default(now())

  @@unique([userId, toolType])
  @@map("analysis_drafts")
}

enum QaqcToolType {
  CRM
  BLANKS
  DUPLICATES
  Z_SCORE
  CHECK_ASSAY
}

// ─────────────────────────────────────────────────────────────────────────────
// Admin Settings
// ─────────────────────────────────────────────────────────────────────────────

model AppSettings {
  id              String @id @default("singleton")
  stripeSecretKey String? @db.Text
  stripePublicKey String?
  updatedAt       DateTime @updatedAt

  @@map("app_settings")
}
